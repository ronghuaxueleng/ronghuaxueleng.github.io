---
title: 发布订阅模式
tag: javascript
category: javascript
abbrlink: 84bd9124
date: 2016-10-12 00:00:00
modifiedOn: 2016-10-12 00:00:00
---

* * *

> 发布—订阅模式又叫观察者模式，它定义对象间的一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知。在JavaScript开发中，我们一般用事件模型来替代传统的发布—订阅模式。

  * 发布—订阅模式可以广泛应用于异步编程中，这是一种替代传递回调函数的方案。比如，我们可以订阅ajax 请求的error、succ 等事件。 或者如果想在动画的每一帧完成之后做一些事情，那我们可以订阅一个事件，然后在动画的每一帧完成之后发布这个事件。在异步编程中使用发布—订阅模式，我们就无需过多关注对象在异步运行期间的内部状态，而只需要订阅感兴趣的事件发生点。

  * 发布—订阅模式可以取代对象之间硬编码的通知机制，一个对象不用再显式地调用另外一个对象的某个接口。发布—订阅模式让两个对象松耦合地联系在一起，虽然不太清楚彼此的细节，但这不影响它们之间相互通信。当有新的订阅者出现时，发布者的代码不需要任何修改；同样发布者需要改变时，也不会影响到之前的订阅者。只要之前约定的事件名没有变化，就可以自由地改变它们。

### DOM 事件

实际上，只要我们曾经在DOM节点上面绑定过事件函数，那我们就曾经使用过发布—订阅模式，例如

    
    
    document.body.addEventListener( 'click', function(){
        alert(2);
    }, false );
    document.body.click(); // 模拟用户点击

在这里需要监控用户点击`document.body`的动作，但是我们没办法预知用户将在什么时候点击。所以我们订阅`document.body`上的`click`事件，当`body` 节点被点击时，`body`节点便会向订阅者发布这个消息。当然我们还可以随意增加或者删除订阅者，增加任何订阅者都不会影响发布者代码的编写。

### 自定义事件

除了DOM 事件，我们还会经常实现一些自定义的事件，这种依靠自定义事件完成的发布—订阅模式可以用于任何JavaScript 代码中。  
步骤：

  * 指定好谁充当发布者（例如售楼处）

  * 然后给发布者添加一个缓存列表，用于存放回调函数以便通知订阅者（售楼处的花名册）

  * 最后发布消息的时候，发布者会遍历整个缓存列表，依次触发里面存放的订阅者回调函数（遍历花名册挨个发短信通知有空房）  
另外，我们还可以往回调函数里填入一些参数，订阅者可以接收这些参数。这是很有必要的，比如售楼处可以在发给订阅者的短信里加上房子的单价、面积、容积率等信息，订阅者接收到这些信息之后可以进行各自的处理。

    
    
    var salesOffices = {}; // 定义售楼处
    salesOffices.clientList = {}; // 缓存列表，存放订阅者的回调函数
    salesOffices.listen = function( key, fn ){
        if ( !this.clientList[ key ] ){ // 如果还没有订阅过此类消息，给该类消息创建一个缓存列表
            this.clientList[ key ] = [];
        }
        this.clientList[ key ].push( fn ); // 订阅的消息添加进消息缓存列表
    };
    
    salesOffices.trigger = function(){ // 发布消息
        var key = Array.prototype.shift.call( arguments ), // 取出消息类型（shift从数组中删除第一个元素并返回该元素）
        fns = this.clientList[ key ]; // 取出该消息对应的回调函数集合
        if ( !fns || fns.length === 0 ){ // 如果没有订阅该消息，则返回
            return false;
        }
        for( var i = 0, fn; fn = fns[ i++ ]; ){
            fn.apply( this, arguments ); // (2) // arguments 是发布消息时附送的参数
        }
    };
    salesOffices.listen( 'squareMeter88', function( price ){ // 小明订阅88 平方米房子的消息
        console.log( '价格= ' + price ); // 输出： 2000000
    });
    salesOffices.listen( 'squareMeter110', function( price ){ // 小红订阅110 平方米房子的消息
        console.log( '价格= ' + price ); // 输出： 3000000
    });
    salesOffices.trigger( 'squareMeter88', 2000000 ); // 发布88 平方米房子的价格
    salesOffices.trigger( 'squareMeter110', 3000000 ); // 发布110 平方米房子的价格

